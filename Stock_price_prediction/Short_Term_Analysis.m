
 

clc;
clear;

%dapan=[3102.12600000000,3140.32500000000,3150.33400000000,3158.40000000000,3139.87700000000,3153.74300000000,3130.67400000000,3132.48600000000,3123.16600000000,3144.37400000000,3140.01400000000,3156.21200000000,3147.45300000000,3157.87300000000,3185.44400000000,3191.19700000000,3173.20100000000,3188.06300000000,3192.42700000000,3195.91200000000,3182.80400000000,3207.13400000000,3212.44400000000,3217.95700000000,3212.63200000000,3203.03800000000,3197.54400000000,3218.16300000000,3222.41700000000,3176.46500000000,3187.56700000000,3230.97600000000,3244.86500000000,3237.98200000000,3250.59900000000,3243.68900000000,3247.67500000000,3249.78100000000,3253.24000000000,3273.02800000000,3292.63800000000,3285.05700000000,3272.92900000000,3262.08100000000,3279.45700000000,3281.87300000000,3275.57300000000,3261.74900000000,3208.54100000000,3237.36000000000,3251.26200000000,3246.45100000000,3268.43000000000,3268.72400000000,3286.90600000000,3290.22600000000,3287.70500000000,3271.51200000000,3331.52200000000,3362.65100000000,3365.22600000000,3363.62700000000,3360.81000000000,3367.11900000000,3379.58300000000,3384.31700000000,3385.38900000000,3365.49700000000,3365.24300000000,3376.41900000000,3379.48800000000,3384.14700000000,3371.42600000000,3353.61900000000,3362.85900000000,3356.84500000000,3365.99600000000,3357.81200000000,3352.52900000000,3341.54900000000,3343.58300000000,3345.27200000000,3339.64200000000,3348.94300000000,3374.37800000000,3382.98800000000,3388.28400000000,3386.10000000000,3390.52300000000,3378.47000000000,3372.04100000000,3381.79400000000,3370.17200000000,3378.64800000000,3380.69900000000,3388.24800000000,3396.89800000000,3407.56700000000,3416.81200000000,3390.33700000000,3393.34200000000,3395.91300000000,3383.31000000000,3371.74400000000,3388.17400000000,3413.57500000000,3415.46000000000,3427.79500000000,3432.67300000000,3447.83600000000,3429.54800000000,3402.52500000000,3399.25000000000,3382.90800000000,3392.39900000000,3410.49800000000,3430.46400000000,3351.91800000000,3353.82100000000,3322.23000000000,3333.65700000000,3337.86200000000,3317.18800000000,3317.61700000000,3309.61800000000,3303.67500000000,3293.96500000000,3272.05400000000,3289.99200000000,3322.19600000000,3280.81400000000,3303.03700000000,3292.43900000000,3266.13700000000,3267.92200000000,3296.53800000000,3287.60600000000,3300.05900000000,3297.06300000000,3280.46100000000,3306.12500000000,3275.78300000000,3296.38500000000,3307.17200000000,3348.32600000000,3369.10800000000,3385.71000000000,3391.75000000000,3409.48000000000,3413.90000000000,3421.83400000000,3425.34500000000,3428.94100000000,3410.48800000000,3436.59400000000,3444.67100000000,3474.75400000000,3487.86400000000,3501.36200000000,3546.50500000000,3559.46500000000,3548.30700000000,3558.12900000000,3523.00100000000,3488.00900000000,3480.83300000000,3446.98000000000,3462.08100000000,3487.49700000000,3370.65200000000,3309.26000000000,3262.05000000000,3129.85100000000,3154.12500000000,3184.95900000000,3199.15900000000,3268.55900000000,3289.02400000000,3329.57400000000,3292.06800000000,3259.40800000000,3273.75500000000,3254.52800000000,3256.92600000000,3289.64200000000,3271.66800000000,3288.40600000000,3307.16600000000,3326.69900000000,3310.23900000000,3291.38200000000,3291.11200000000,3269.88200000000,3279.25200000000,3290.64000000000,3280.95200000000,3263.48000000000,3152.76100000000,3133.72200000000,3166.64900000000,3122.29000000000,3160.53100000000,3168.89700000000,3163.17900000000,3136.63300000000,3131.11100000000,3138.29400000000,3190.32200000000,3208.08200000000,3180.15800000000,3159.05200000000,3110.64900000000,3066.79700000000,3091.39900000000,3117.37600000000,3071.54300000000,3068.01200000000,3128.92700000000,3117.97400000000,3075.03000000000,3082.23200000000,3081.17700000000,3100.85900000000,3091.03300000000,3136.64500000000,3161.49800000000,3159.15000000000,3174.41300000000,3163.26300000000,3174.03200000000,3192.11800000000,3169.56500000000,3154.28300000000,3193.30300000000,3213.84000000000,3214.35000000000,3168.96400000000,3154.65100000000,3141.30300000000,3135.08200000000,3120.46100000000,3041.44300000000,3095.47400000000,3075.13700000000,3091.19100000000,3114.20600000000,3115.18000000000,3109.49900000000,3067.14800000000,3052.78300000000,3079.80200000000,3049.79700000000,3044.16000000000,3021.90100000000,2907.82200000000,2915.73100000000,2875.81000000000,2889.76000000000,2859.33600000000,2844.50800000000,2813.17800000000,2786.89700000000,2847.41800000000,2775.55700000000,2786.88800000000,2759.12600000000,2733.88200000000,2747.22900000000,2815.11000000000,2827.62500000000,2777.77100000000,2837.65900000000,2831.18400000000,2814.04200000000,2798.12600000000,2787.25700000000,2772.54500000000,2829.27100000000,2859.54200000000,2905.56200000000,2903.64700000000,2882.22500000000,2873.59400000000,2869.05000000000,2876.40100000000,2824.53400000000,2768.02400000000,2740.44300000000,2705.15700000000,2779.37400000000,2744.07000000000,2794.38200000000,2795.31000000000,2785.87200000000,2780.96500000000,2723.25800000000,2705.19200000000,2668.96600000000,2698.46600000000,2733.82600000000,2714.60800000000,2724.62400000000,2729.43100000000,2780.89900000000,2777.98100000000,2769.29500000000,2737.73700000000,2725.25000000000,2720.73400000000,2750.58000000000,2704.33700000000,2691.59300000000,2702.30100000000,2669.48500000000,2664.80000000000,2656.11000000000,2686.57800000000,2681.64300000000,2651.78900000000,2699.95000000000,2730.85000000000,2729.24400000000,2797.48500000000,2781.13900000000,2806.81300000000,2791.77500000000,2821.35000000000,2716.51000000000,2721.01300000000,2725.83700000000,2583.45800000000,2606.91300000000,2568.09800000000,2546.33000000000,2561.61400000000,2486.41900000000,2550.46500000000,2654.87600000000,2594.82600000000,2603.29500000000,2603.80000000000,2598.84700000000,2542.10300000000,2568.04800000000,2602.78300000000,2606.23700000000,2676.47600000000,2665.43100000000,2659.35600000000,2641.34200000000,2635.63200000000,2598.87200000000,2630.52000000000,2654.88000000000,2632.24300000000,2668.17000000000,2679.11000000000,2703.51200000000,2645.85500000000,2651.50500000000,2645.43400000000,2579.48300000000,2575.81000000000,2574.67900000000,2601.73700000000,2567.44300000000,2588.18800000000,2654.79800000000,2665.95800000000,2649.80500000000,2605.18100000000,2605.88800000000,2584.58200000000,2594.08800000000,2602.15300000000,2634.04900000000,2593.74100000000,2597.97400000000,2576.65000000000,2549.56300000000,2536.26800000000,2516.25100000000,2527.00700000000,2504.81900000000,2498.29400000000,2483.08600000000,2493.89600000000,2465.29100000000,2464.36300000000,2514.86800000000,2533.08900000000,2526.46200000000,2544.34500000000,2535.09900000000,2553.83100000000,2535.76500000000,2570.34500000000,2570.42200000000,2559.63700000000,2596.01];
  
%addpath(genpath(pwd));
xlsx_file_list=scan_xlsx_file();% read in all the stock path
file_number=length(xlsx_file_list);

%第一行：日期 %第二行：开盘价 %第三行：最高价 %第四行：最低价 %第五行：收盘价 %第六行：成交量
%7行：外盘 %8行：内盘 %9行：涨跌 %10行：换手率 %11行：市净率 %12行：流通市值 %13行：总市值
%14行：市盈率 %15行：主力流入 %16行：主力流出 %17行：主力净流入 %18行：散户流入 %19行：散户流出 %20行：散户净流入

analysis_sheet={};%用于记录分析结果
analysis_sheet{1,1}='股票'; analysis_sheet{1,2}='当日波动'; analysis_sheet{1,3}='是否反弹';analysis_sheet{1,4}='是否暴跌';analysis_sheet{1,5}='出息除权'; analysis_sheet{1,6}='K30>K5_100'; analysis_sheet{1,7}='K30>K5_300';analysis_sheet{1,8}='K30>K5_400';analysis_sheet{1,9}='最大跌幅'; analysis_sheet{1,10}='双W底'; analysis_sheet{1,11}='主力活跃度';analysis_sheet{1,12}='主力流入100天';analysis_sheet{1,13}='主力流入200天';analysis_sheet{1,14}='主力流入300天'; analysis_sheet{1,15}='主力平均买入价'; analysis_sheet{1,16}='主力平均卖出价';analysis_sheet{1,17}='交易量放大';analysis_sheet{1,18}='外盘大于内盘时，股价上涨的概率'; analysis_sheet{1,19}='当外盘小于内盘时，股价下跌的概率'; analysis_sheet{1,20}='当前价格';

m=1;%用于记录有效的数据

for i=1:1%file_number
    
    historial_data={};  %循环开始就要把数据初始化，
    %data_TX=[];

    data_TX =xlsread(xlsx_file_list{i});  %腾讯的数据
    [data_TX_row, data_TX_col]=size(data_TX);
    
    if strcmp(xlsx_file_list{i} , 'C:\Users\Qiuyinz\Desktop\stock\stock_data_tengxun\sz399001.xlsx') || strcmp(xlsx_file_list{i} , 'C:\Users\Qiuyinz\Desktop\stock\stock_data_tengxun\sh000001.xlsx')
        continue;   %跳过两个大盘
    end
   
    %获取过去400天的历史股价
   try
     historial_data=get_historal_data_function(xlsx_file_list{i}(end-12:end-5)); %新浪的数据
     [historial_data_row, historial_data_col] = size( historial_data );
%%  
     %判断数据是否有效，主要看最后的日期是否是一致
     % 2019-01-03 20190103
       last_date_TX = data_TX(1,data_TX_col);
       last_date_XL = historial_data{1,historial_data_col};
       last_date_XL=str2double([last_date_XL(1:4),last_date_XL(6:7),last_date_XL(9:10)]);
     
       if last_date_TX ~= last_date_XL
          disp(['error happened at',xlsx_file_list{i}]);  %如果两个数据不属于同一个日期，则跳过！
          continue;
       else
          historial_data=cell2mat( historial_data(2:end,2:end));
       end 
   catch
       historial_data=data_TX(2:6,:);
   end
      
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     数据准备   %%%%%%%%%%%   数据准备   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   

%% 判断近期的股价波动
%        data1=[data_TX(2:5,:);data_TX(9,:)];       
%        results1=recent_price_fluctuations(data1);    %1：计算当天股价是不是剧烈波动,返回正值，越大说明波动就越剧烈 【0――0.2】 --------
                                                       %2：当天股价是否强势反弹。正值，强势反弹，负值：危险信号【-0.4――0.4】----------
                                                       %3：近五天股价表现：1 暴涨，0.5小涨，-0.5小跌，-1暴跌（跌幅超过8%）   %【0,1】-----
%%
       %输入历史股价，最好是 1x400
        data2=historial_data(4,1:end); 
       % data2=data2(1:283);
       % results2=stock_price_trend(data2); %1:判断过去200天中是不是除权出息，---------------
                                            %2:在过去100天中，K30大于K5的天数--------------
                                            %3:过去300天中K30大于K5的天数,----------------
                                            %4:过去400天中K30大于K5的天数 -------------
                                            %5:过去400天，股价最大跌幅 【0,1】 为0，创新高
                                            %数据低于50的不判断,返回5个0                                  
%% 输入应该是1*n的数列，当数列长度小于200不分析，最佳长度是400
%     
%                                                    %输入就是历史股价，用处不大
%          results3=double_w_bottom(data2);          %1:判断双W底是否形成-------------
                                                     %2:n 返回所有有效的极值点的位置,包括极大值和极小值。
                                                     %第一个和最后一个极值肯定是极大值
                                          
 %%                                         
 %% 输入应该是1*n的数列，当数列长度小于200不分析，最佳长度是400
                                   
%%要将股票分出不同的阶段
%%输入：过去400天的历史数据
%%%%%%这个非常重要
% 
%                                           %输入就是历史股价
  different_stages=stage_division(data2);   %返回一定是一个三的倍数的数据，中间的数表示涨跌
                                            
                                            
 %% 
%输入应该是8*n,
%股价
%Main inflow
%Main outflow
%4：Main net inflow
%Retail inflow
%Retail outflow
%Retail net inflow
%Circulation market value
 
%      data4 = [  data_TX(5,:);data_TX(15:20,:); data_TX(12,:)  ]; 
%      results4=capital_flow_analysis(data4);    %输出分别是:
                                                 %1:在最近100天，主力是否活跃，值越大说明主力近期更活跃------5
                                                 %2―4：近100,200,300天，主力净流入市值百分比
                                                 %5-6：近300天主力平均买入价,平均卖出价
                                                 %如果平均买入价高于卖出价，说明庄稼随股价的影响很大，庄稼买入就会涨，庄稼卖出就跌
                                                 %如果平均买入价低于卖出价，这说明庄想横盘，趁机吸筹
                                            
%% 外盘和内盘的关系
%     
%      data5= [  data_TX(5,:); data_TX(9,:); data_TX(7:8,:); ];
%      
%      results5=outer_inner_disk_analysis(data5);             %1: 交易量是不是突然放大,今天的交易量和过去20天交易量的平均值的比，比值大于1，说明比平均值大
                                                              %2: 近300天内，当外盘大于内盘时，股价上涨的概率, 值越靠近0 或者1时，越说明有规律,是个耿直的庄稼
                                                              %3: 近300天内，当外盘小于内盘时，股价下跌的概率，值越靠近0 或者1时，越说明有规律,是个耿直的庄稼
     
                                                           
%% 要分析在连个极值点之间，内盘和外盘之间怎么变化

%每个股票的个性化研究
%比如，在极大极小之间量的情况，主力资金的情况，还有外盘和内盘的情况
% %    
%        data6_1=different_stages;%极值传入
%        data6_2=  data_TX(6:20,:);  %腾讯的数据
%        results6=individual_stock_characteristics(data6_1,data6_2);   %输出第一列：上涨初期
                                                                      %输出第2列：上涨末期
                                                                      %输出第3列：下跌初期
                                                                      %输出第4列：下跌末期
                                                                      %输出第5列：横盘初期
                                                                      %输出第6列：横盘末期
                                                                      %输出第7列：最近是跌还是涨
                                                                      %输出第8列：最近初期
                                                                      %输出第9列：最近末期
 %% 曲线和大盘的关系   
 % 这个分析方法也要
 % 经过一段时间收集，如果主力用很少的资金就能轻松地拉出涨停，那就说明主力筹码收集工作已近尾声，具备了控盘能力，可以随心所欲地控制盘面
 % 1.当天的主力资金净流入与指数涨跌相反。比如该板块或个股全天总体来看指数是下跌的，但主力资金净流入为正，一般说明主力在打压洗盘，借势吸筹，拉升在即，可跟庄做多。
 % 2.当天的主力资金流向与指数涨跌幅在幅度上存在较大背离。比如全天指数涨幅较高，但实际资金净流入量很小，一般说明主力在明拉暗出，要小心为妙。
 
 
 
 
 %% 这个股票前天强势反弹后第二天上涨的概率&&冲高回落后第二天下跌的概率 %% 当天涨停后，第二天上涨的概率 && 当天跌停后第二天下跌的概率 %% 当天成交量大幅上涨后，第二天上涨的概率
%     data7=historial_data(1:5,1:end); 
%     results7=probability_statistics_analysis(data7); %1：强势反弹。2：冲高回落
                                                     %3：大涨。4：大跌
                                                     %5：成交量大涨
                                                     %6：反弹 && 成交量大增    
                                                     %7：大涨 && 成交量大增 
   
%% 制表输出
%   if length(different_stages)>=6
% 
%      if different_stages(end-1) == 1 && different_stages(end-4) == -1 && results2(5)>0.65 && results1(3) ==-1
%           analysis_sheet{m+1,1}= xlsx_file_list{i}(end-12:end-5);
% %         analysis_sheet{m+1,2}= results1(1);analysis_sheet{m+1,3}= results1(2);analysis_sheet{m+1,4}= results1(3);
% %         analysis_sheet{m+1,5}= results2(1);analysis_sheet{m+1,6}= results2(2);analysis_sheet{m+1,7}= results2(3);analysis_sheet{m+1,8}= results2(4);analysis_sheet{m+1,9}= results2(5);
% %         analysis_sheet{m+1,10}= results3(1);
% %         analysis_sheet{m+1,11}= results4(1);analysis_sheet{m+1,12}= results4(2);analysis_sheet{m+1,13}= results4(3);analysis_sheet{m+1,14}= results4(4);analysis_sheet{m+1,15}= results4(5);analysis_sheet{m+1,16}= results4(6);
% %         analysis_sheet{m+1,17}= results5(1);analysis_sheet{m+1,18}= results5(2);analysis_sheet{m+1,19}= results5(3);
% %         analysis_sheet{m+1,20}= data_TX(5,end);
%          m=m+1;
%      end
%    
%   end


%     plot(10*historial_data(5,:)/max(historial_data(5,:)))
%     plot(10*dapan/max(dapan))
%     data_TX=[zeros(data_TX_row,400-data_TX_col),data_TX];
%     plot(10*data_TX(17,:)/max(data_TX(17,:)) );
%     plot(10*data_TX(20,:)/max(data_TX(20,:)) );
end
    

    
    
%% 生成excel输出数据

analysis_report_path=['C:\Users\Qiuyinz\Desktop\stock\Analysis_Report\',date,'_','Short_Term_Analysis_Report.xlsx'];
%xlswrite( analysis_report_path,analysis_sheet);
 
 %% 上次预测的准确度，读入上一次的报告文件

%%




























